# TODO: Repo uses Library via Composition ✅ COMPLETE

## Problem

The current `Repo` class duplicates `Library` properties and uses `as any` casts when passing to fuz components (`LibrarySummary`, `LibraryDetail`, `DocsFooter`). The `source_json` was stubbed with empty `modules: []`, making the modules page non-functional.

## Solution

1. **`Repo` has `readonly library: Library`** - composition, delegates to library for all package metadata
2. **Require real `library_json`** - read from each repo's `library.ts` file (generated by gro)
3. **Local reads, no network fetches** - repos are cloned locally, import directly
4. **Validation** - gitops validates that repos have valid `library.ts`, halts with actionable error if missing

## Design

### Standardize on `$routes/library.ts`

All repos must have `src/routes/library.ts` that exports:

```ts
export const library_json: LibraryJson = {...};
```

This is generated by `gro gen` from a `library.gen.ts` file:

```ts
// src/routes/library.gen.ts
import {library_gen} from '@ryanatkn/fuz/library_gen.js';
export const gen = library_gen();
```

CI keeps `library.ts` in sync via `gro gen --check`.

### RepoJson (serialized to repos.ts)

```ts
import type {LibraryJson} from '@ryanatkn/belt/library_json.js';

export interface RepoJson {
	library_json: LibraryJson;
	check_runs: GithubCheckRunsItem | null;
	pull_requests: Array<GithubPullRequest> | null;
}
```

### Repo class (composition)

```ts
import {Library} from '@ryanatkn/fuz/library.svelte.js';

export class Repo {
	readonly library: Library;
	check_runs: GithubCheckRunsItem | null;
	pull_requests: Array<GithubPullRequest> | null;

	// Convenience getters delegating to library
	get name(): string {
		return this.library.name;
	}
	get repo_name(): string {
		return this.library.repo_name;
	}
	// ... etc

	constructor(repo_json: RepoJson) {
		this.library = new Library(repo_json.library_json);
		this.check_runs = repo_json.check_runs;
		this.pull_requests = repo_json.pull_requests;
	}
}
```

### Resolution types (domain-first naming)

```ts
// Before loading - just filesystem location info
interface LocalRepoPath {
	type: 'local_repo_path';
	repo_name: string; // from URL parsing (for display/logging before Library loaded)
	repo_dir: string; // filesystem path
	repo_url: string; // from config
	repo_git_ssh_url: string; // for git operations
	repo_config: GitopsRepoConfig;
}

interface LocalRepoMissing {
	type: 'local_repo_missing';
	repo_name: string;
	repo_url: string;
	repo_git_ssh_url: string;
	repo_config: GitopsRepoConfig;
}
```

### LocalRepo interface (no longer extends)

```ts
// LocalRepo does NOT extend LocalRepoPath - avoids duplication
// Library is source of truth for name, repo_name, repo_url
export interface LocalRepo {
	library: Library;
	library_json: LibraryJson;
	repo_dir: string;
	repo_git_ssh_url: string;
	repo_config: GitopsRepoConfig;
	dependencies?: Map<string, string>;
	dev_dependencies?: Map<string, string>;
	peer_dependencies?: Map<string, string>;
}
```

### Function names (domain-first pattern)

```ts
local_repo_locate(); // was resolve_local_repo()
local_repos_ensure(); // was resolve_local_repos()
local_repo_load(); // was load_local_repo()
local_repos_load(); // was load_local_repos()
```

### Validation flow

```
get_gitops_ready()
  ├── local_repos_ensure()     ← downloads missing repos if --download
  │     └── local_repo_locate()  ← checks if repo exists on filesystem
  └── local_repos_load()
        └── local_repo_load()  ← validation here, fails fast on first missing library.ts
```

## Completed Tasks

### Import updates

- [x] `@ryanatkn/belt/src_json.js` → `@ryanatkn/belt/source_json.js`
- [x] `@ryanatkn/fuz/pkg.svelte.js` → `@ryanatkn/fuz/library.svelte.js`
- [x] `@ryanatkn/fuz/package_helpers.js` → `@ryanatkn/fuz/library_helpers.js`
- [x] `@ryanatkn/fuz/PackageDetail.svelte` → `@ryanatkn/fuz/LibraryDetail.svelte`
- [x] `@ryanatkn/fuz/PackageSummary.svelte` → `@ryanatkn/fuz/LibrarySummary.svelte`

### Type/interface renames

- [x] `ResolvedLocalRepo` → `LocalRepoPath`
- [x] `UnresolvedLocalRepo` → `LocalRepoMissing` (descriptor-last pattern)
- [x] `MaybeLocalRepo` → removed, use union `LocalRepoPath | LocalRepoMissing`
- [x] `LocalRepo` no longer extends, has only needed fields

### Function renames (domain-first)

- [x] `resolve_local_repo()` → `local_repo_locate()`
- [x] `resolve_local_repos()` → `local_repos_ensure()`
- [x] `load_local_repo()` → `local_repo_load()`
- [x] `load_local_repos()` → `local_repos_load()`

### Core changes

- [x] Update `RepoJson` to have `library_json: LibraryJson`
- [x] Update `Repo` class to use composition with `Library`
- [x] Update `LocalRepo` interface: `pkg: Pkg` → `library: Library`
- [x] Update `local_repo_load()` to import from `library.ts` with validation
- [x] Update `fetch_repo_data.ts` to use `library.package_json`
- [x] Update `resolved_gitops_config.ts` with new type names
- [x] Update `gitops_task_helpers.ts` with new function names

### UI updates

- [x] Remove all `as any` casts from UI components
- [x] Update UI component imports and prop access
- [x] Update tomes: `related_identifiers` → `related_declarations`
- [x] Update `ReposTree.svelte` to use `LibrarySummary`, `LibraryDetail`
- [x] Update `ModulesDetail.svelte` to use `declarations` (was `identifiers`)
- [x] Update all route files with `library_context`

### Gen files

- [x] `package.gen.ts` → `library.gen.ts`
- [x] Delete `package.ts`, regenerate as `library.ts`

### Tests

- [x] Update test helpers to use Library (`create_mock_library_json`, `create_mock_repo`)
- [x] Update fixture loaders (`load_repo_fixtures.ts`)
- [x] All 383 tests pass

## Benefits Achieved

- No type lies or stubs
- No `as any` casts
- fuz components work directly with `repo.library`
- Modules page shows real module/declaration data
- gitops enforces `library.ts` requirement with clear error messages
- No network fetches during sync (local reads)
- CI keeps `library.ts` in sync via `gro gen --check`

## Notes

- `src/routes/library.ts` is the required location
- gitops validation halts with actionable error if `library.ts` is missing
- `LocalRepoPath` (filesystem/git concerns) is separate from `Library` (package metadata)
- `LocalRepo` does not extend `LocalRepoPath` - avoids field duplication
- `Library` is single source of truth for `name`, `repo_name`, `repo_url`
- `LocalRepoPath.repo_name` only used for logging/display before Library is loaded
- Naming follows fuz convention: domain-first, descriptor-last (e.g., `LocalRepoMissing` not `MissingLocalRepo`)
